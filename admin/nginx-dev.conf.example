# Dev server reverse proxy — HTTPS + basic auth for all projects
# Upstream services
upstream wazetracker    { server 127.0.0.1:5051; }
upstream reusparty      { server 127.0.0.1:5050; }
upstream webwars-admin  { server 127.0.0.1:5052; }
upstream webwars-dev    { server 127.0.0.1:8081; }
upstream webwars-gw     { server 127.0.0.1:8080; }
upstream influxdb       { server 127.0.0.1:8086; }
upstream dncc           { server 127.0.0.1:5001; }

server {
    listen 80;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name YOUR_SERVER_IP;

    ssl_certificate     /etc/nginx/ssl-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl-selfsigned.key;

    auth_basic "Control Center";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # WebWars Admin
    location /admin/ {
        proxy_pass http://webwars-admin/;
    }

    # Waze Tracker
    location /waze/ {
        proxy_pass http://wazetracker/;
    }

    # Reus Party Tracker
    location /reus/ {
        proxy_pass http://reusparty/;
    }

    # WebWars Dev (game engine)
    location /webwars/ {
        proxy_pass http://webwars-dev/;
    }

    # WebWars WS gateway
    location /ws {
        auth_basic off;
        proxy_pass http://webwars-gw;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # InfluxDB
    location /influx/ {
        proxy_pass http://influxdb/;
    }

    # DNCC
    location /dncc/ {
        proxy_pass http://dncc/;
    }

    # Default — show index of services
    location = / {
        auth_basic "Control Center";
        auth_basic_user_file /etc/nginx/.htpasswd;
        root /var/www/cc;
    }

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
