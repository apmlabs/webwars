<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>WebWars — Lobby</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
a{color:#4fc3f7;text-decoration:none}
button{cursor:pointer;font-family:inherit}

/* Header */
header{background:linear-gradient(180deg,#161b2e,#0d1120);padding:12px 24px;border-bottom:1px solid #1e2744;display:flex;align-items:center;gap:16px}
.logo{font-weight:800;font-size:18px;background:linear-gradient(135deg,#4fc3f7,#66bb6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#conn-status{font-size:12px;padding:3px 10px;border-radius:10px;background:#1a2040;color:#8892b0}
#conn-status.ok{background:#1b3a1b;color:#66bb6a}
#conn-status.err{background:#3a1b1b;color:#ef5350}
.spacer{flex:1}
#nick-display{font-size:13px;color:#8892b0}

/* Main layout */
main{flex:1;display:flex;overflow:hidden}

/* Panels */
.panel{display:flex;flex-direction:column;border-right:1px solid #1e2744}
.panel-header{padding:10px 16px;background:#111628;border-bottom:1px solid #1e2744;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px}
.panel-body{flex:1;overflow-y:auto;padding:8px}

/* Rooms panel */
#rooms-panel{width:320px}
.room-item{padding:10px 12px;border-radius:6px;margin-bottom:4px;cursor:pointer;font-size:13px;transition:background .1s}
.room-item:hover{background:#1a2040}
.room-item .room-name{font-weight:600;margin-bottom:2px}
.room-item .room-info{font-size:11px;color:#8892b0}

/* Center area */
#center{flex:1;display:flex;flex-direction:column}

/* Room config / game area */
#room-view{flex:1;display:flex;flex-direction:column;display:none}
#room-header{padding:12px 16px;background:#111628;border-bottom:1px solid #1e2744;display:flex;align-items:center;gap:12px}
#room-header h2{font-size:15px;font-weight:600}
#room-config{flex:1;padding:16px;overflow-y:auto;display:flex;gap:16px;flex-wrap:wrap;align-content:flex-start}
.config-section{background:#111628;border:1px solid #1e2744;border-radius:8px;padding:14px;min-width:280px;flex:1}
.config-section h3{font-size:13px;font-weight:600;margin-bottom:10px;color:#4fc3f7}
.config-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:13px}
.config-row label{color:#8892b0}
.config-row select,.config-row input{background:#0d1120;border:1px solid #2a3352;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:12px}

/* Welcome / lobby view */
#lobby-view{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#lobby-view h1{font-size:28px;font-weight:800;background:linear-gradient(135deg,#4fc3f7,#66bb6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#lobby-view p{color:#8892b0;font-size:14px;max-width:400px;text-align:center}

/* Chat */
#chat-panel{width:280px;display:flex;flex-direction:column;border-left:1px solid #1e2744}
#chat-messages{flex:1;overflow-y:auto;padding:8px;font-size:12px}
.chat-msg{margin-bottom:4px;word-wrap:break-word}
.chat-msg .nick{font-weight:600;color:#4fc3f7}
.chat-msg.sys{color:#8892b0;font-style:italic}
#chat-input{display:flex;border-top:1px solid #1e2744}
#chat-input input{flex:1;background:#0d1120;border:none;color:#e0e0e0;padding:10px 12px;font-size:12px;outline:none}
#chat-input button{background:#1a2040;border:none;color:#4fc3f7;padding:10px 14px;font-size:12px}

/* Buttons */
.btn{padding:8px 16px;border-radius:6px;border:1px solid #2a3352;background:#1a2040;color:#e0e0e0;font-size:13px;transition:all .15s}
.btn:hover{border-color:#4fc3f7;color:#4fc3f7}
.btn-primary{background:linear-gradient(135deg,#1565c0,#0d47a1);border-color:#1976d2;color:#fff}
.btn-primary:hover{background:linear-gradient(135deg,#1976d2,#1565c0)}
.btn-success{background:linear-gradient(135deg,#2e7d32,#1b5e20);border-color:#388e3c;color:#fff}
.btn-success:hover{background:linear-gradient(135deg,#388e3c,#2e7d32)}
.btn-danger{background:#3a1b1b;border-color:#c62828;color:#ef5350}
.btn-sm{padding:5px 10px;font-size:11px}

/* Players list in room */
.player-item{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:13px;border-radius:4px}
.player-item.ready{color:#66bb6a}
.player-item .ready-dot{width:8px;height:8px;border-radius:50%;background:#2a3352}
.player-item.ready .ready-dot{background:#66bb6a}

/* Login overlay */
#login-overlay{position:fixed;inset:0;background:rgba(6,8,18,0.9);display:flex;align-items:center;justify-content:center;z-index:100}

/* Game overlay — fullscreen canvas over lobby */
#game-overlay{display:none;position:fixed;inset:0;z-index:150;background:#000}
#game-overlay canvas{width:100vw;height:100vh;display:block}
#game-overlay .game-topbar{position:absolute;top:0;left:0;right:0;height:32px;background:rgba(13,17,32,0.8);display:flex;align-items:center;padding:0 12px;z-index:160;font-size:12px}
#game-overlay .game-topbar span{color:#8892b0;margin-right:16px}
#game-overlay .game-topbar button{background:none;border:1px solid #2a3352;color:#8892b0;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:11px;margin-left:auto}
#login-box{background:#111628;border:1px solid #1e2744;border-radius:12px;padding:32px;text-align:center;min-width:320px}
#login-box h2{margin-bottom:16px;font-size:20px}
#login-box input{width:100%;padding:10px 14px;background:#0d1120;border:1px solid #2a3352;border-radius:6px;color:#e0e0e0;font-size:14px;margin-bottom:12px;outline:none;text-align:center}
#login-box input:focus{border-color:#4fc3f7}
</style>
</head>
<body>

<!-- Login -->
<div id="login-overlay">
  <div id="login-box">
    <h2>⚔️ WebWars</h2>
    <p style="color:#8892b0;font-size:13px;margin-bottom:16px">Enter a nickname to join</p>
    <input id="nick-input" type="text" placeholder="Nickname" maxlength="40" autofocus>
    <br>
    <button class="btn btn-primary" onclick="doLogin()" style="width:100%">Join Server</button>
  </div>
</div>

<!-- Game overlay (hidden, shown when engine loads) -->
<div id="game-overlay">
  <div class="game-topbar">
    <span id="game-status">Loading engine...</span>
    <button onclick="exitGame()">✕ Exit</button>
  </div>
  <canvas id="game-canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
</div>

<header>
  <span class="logo">WEBWARS</span>
  <span id="conn-status">Disconnected</span>
  <span class="spacer"></span>
  <span id="nick-display"></span>
  <button class="btn btn-sm" onclick="playLocal()">⚡ Quick Play</button>
</header>

<main>
  <!-- Rooms list -->
  <div id="rooms-panel" class="panel">
    <div class="panel-header">
      Rooms
      <span class="spacer"></span>
      <button class="btn btn-sm btn-primary" onclick="createRoom()">+ New</button>
    </div>
    <div class="panel-body" id="rooms-list"></div>
  </div>

  <!-- Center -->
  <div id="center">
    <!-- Lobby welcome (shown when not in a room) -->
    <div id="lobby-view">
      <h1>WebWars</h1>
      <p>Hedgewars in your browser. Create or join a room to play multiplayer, or hit Quick Play for a local hotseat game.</p>
    </div>

    <!-- Room view (shown when in a room) -->
    <div id="room-view">
      <div id="room-header">
        <button class="btn btn-sm btn-danger" onclick="leaveRoom()">← Leave</button>
        <h2 id="room-name-display"></h2>
        <span class="spacer"></span>
        <button class="btn btn-sm" id="btn-ready" onclick="toggleReady()">Ready</button>
        <button class="btn btn-sm btn-success" id="btn-start" onclick="startGame()" style="display:none">Start Game</button>
      </div>
      <div id="room-config">
        <div class="config-section">
          <h3>Map</h3>
          <div class="config-row"><label>Type</label><select id="cfg-mapgen" onchange="sendCfg()"><option value="0">Random</option><option value="1">Maze</option><option value="2">Drawn</option><option value="3">Perlin</option></select></div>
          <div class="config-row"><label>Theme</label><select id="cfg-theme" onchange="sendCfg()"></select></div>
          <div class="config-row"><label>Template</label><select id="cfg-template" onchange="sendCfg()"><option value="0">Small</option><option value="1">Medium</option><option value="2">Large</option><option value="3">Cavern</option><option value="4">Wacky</option></select></div>
        </div>
        <div class="config-section">
          <h3>Scheme</h3>
          <div class="config-row"><label>Turn Time</label><select id="cfg-turntime" onchange="sendCfg()"><option value="15000">15s</option><option value="30000">30s</option><option value="45000" selected>45s</option><option value="60000">60s</option><option value="90000">90s</option></select></div>
          <div class="config-row"><label>Sudden Death</label><select id="cfg-sd" onchange="sendCfg()"><option value="10">10 turns</option><option value="15" selected>15 turns</option><option value="25">25 turns</option><option value="50">50 turns</option></select></div>
          <div class="config-row"><label>Health</label><input id="cfg-health" type="number" value="100" min="1" max="999" style="width:60px" onchange="sendCfg()"></div>
        </div>
        <div class="config-section">
          <h3>Players</h3>
          <div id="players-list"></div>
          <h3 style="margin-top:12px">Teams</h3>
          <div id="teams-list"></div>
          <button class="btn btn-sm" onclick="addTeam()" style="margin-top:8px">+ Add Team</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat-panel" class="panel">
    <div class="panel-header">Chat</div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input id="chat-text" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">Send</button>
    </div>
  </div>
</main>

<script>
// ── State ──
var ws = null;
var myNick = '';
var inRoom = false;
var isChief = false;
var rooms = [];
var players = []; // [{nick, ready, inGame}]
var readySet = {};
var teams = []; // [{name, owner, color, grave, fort, voicepack, flag, diff, hogs:[{name,hat}], hhnum}]
var roomCfg = {}; // map params + game params synced from server
var themes = ['Nature','Cake','Island','Deepspace','Halloween','Cheese','Bath','Bamboo','Blox','EarthRise','Compost','Planes'];

// ── Init ──
(function() {
  var sel = document.getElementById('cfg-theme');
  themes.forEach(function(t) {
    var o = document.createElement('option');
    o.value = t; o.textContent = t;
    sel.appendChild(o);
  });
  document.getElementById('nick-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doLogin();
  });
})();

// ── Connection ──
function connect() {
  var host = location.hostname || 'localhost';
  ws = new WebSocket('ws://' + host + ':8080');
  setStatus('Connecting...', '');

  ws.onopen = function() { setStatus('Connected', 'ok'); };
  ws.onclose = function() { setStatus('Disconnected', 'err'); setTimeout(connect, 3000); };
  ws.onerror = function() { setStatus('Error', 'err'); };
  ws.onmessage = function(e) { handleMsg(JSON.parse(e.data)); };
}

function send(arr) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(arr));
}

function setStatus(text, cls) {
  var el = document.getElementById('conn-status');
  el.textContent = text;
  el.className = cls || '';
}

// ── Login ──
function doLogin() {
  myNick = document.getElementById('nick-input').value.trim();
  if (!myNick) return;
  document.getElementById('login-overlay').style.display = 'none';
  document.getElementById('nick-display').textContent = myNick;
  connect();
}

// ── Protocol handler ──
function handleMsg(msg) {
  var cmd = msg[0];

  if (cmd === 'CONNECTED') { send(['NICK', myNick]); send(['PROTO', '58']); return; }
  if (cmd === 'LOBBY:JOINED') { addChat(null, msg.slice(1).join(', ') + ' joined the lobby'); send(['LIST']); return; }
  if (cmd === 'ROOMS') { parseRooms(msg.slice(1)); return; }
  if (cmd === 'ROOM' && (msg[1] === 'ADD' || msg[1] === 'DEL' || msg[1] === 'UPD')) { send(['LIST']); return; }

  if (cmd === 'JOINED') {
    msg.slice(1).forEach(function(n) {
      if (!players.find(function(p){return p.nick===n})) players.push({nick:n, ready:false, inGame:false});
    });
    renderPlayers(); addChat(null, msg.slice(1).join(', ') + ' joined'); return;
  }
  if (cmd === 'LEFT') {
    var who = msg[1];
    players = players.filter(function(p){return p.nick!==who});
    teams = teams.filter(function(t){return t.owner!==who});
    renderPlayers(); renderTeams(); addChat(null, who + ' left'); return;
  }

  if (cmd === 'CLIENT_FLAGS' || cmd === 'CF') {
    var flags = msg[1]; var nicks = msg.slice(2);
    nicks.forEach(function(n) {
      var p = players.find(function(x){return x.nick===n});
      if (!p) return;
      if (flags.indexOf('+h') !== -1) { if (n === myNick) { isChief = true; updateRoomUI(); } }
      if (flags.indexOf('+r') !== -1) p.ready = true;
      if (flags.indexOf('-r') !== -1) p.ready = false;
      if (flags.indexOf('+g') !== -1) p.inGame = true;
      if (flags.indexOf('-g') !== -1) p.inGame = false;
    });
    renderPlayers(); return;
  }

  if (cmd === 'CHAT') { addChat(msg[1], msg[2]); return; }

  // Team management
  if (cmd === 'TEAM_ACCEPTED') { addChat(null, 'Team "' + msg[1] + '" added'); return; }
  if (cmd === 'ADD_TEAM') {
    // From other player: ADD_TEAM, name, grave, fort, voicepack, flag, owner, diff, hog1name, hog1hat...
    var t = {name:msg[1], grave:msg[2], fort:msg[3], voicepack:msg[4], flag:msg[5], owner:msg[6], diff:msg[7], color:'0', hogs:[], hhnum:4};
    for (var i=8; i+1<msg.length; i+=2) t.hogs.push({name:msg[i], hat:msg[i+1]});
    teams.push(t); renderTeams(); addChat(null, t.owner + ' added team "' + t.name + '"'); return;
  }
  if (cmd === 'REMOVE_TEAM') {
    teams = teams.filter(function(t){return t.name!==msg[1]});
    renderTeams(); addChat(null, 'Team "' + msg[1] + '" removed'); return;
  }
  if (cmd === 'TEAM_COLOR') {
    var tc = teams.find(function(t){return t.name===msg[1]});
    if (tc) tc.color = msg[2];
    renderTeams(); return;
  }
  if (cmd === 'HH_NUM') {
    var th = teams.find(function(t){return t.name===msg[1]});
    if (th) th.hhnum = parseInt(msg[2]);
    renderTeams(); return;
  }

  // Config sync
  if (cmd === 'CFG') {
    roomCfg[msg[1]] = msg.slice(2);
    applyCfgToUI(msg[1], msg.slice(2));
    addChat(null, 'Config: ' + msg[1] + ' = ' + msg.slice(2).join(' '));
    return;
  }

  // Game start
  if (cmd === 'RUN_GAME') { addChat(null, 'Game starting!'); launchEngine(); return; }
  if (cmd === 'ROUND_FINISHED') { addChat(null, 'Round finished'); return; }
  if (cmd === 'EM') { handleEngineMsg(msg[1]); return; }

  if (cmd === 'PING') { send(['PONG']); return; }
  if (cmd === 'BYE') { addChat(null, 'Disconnected: ' + (msg[1]||'')); return; }
  if (cmd === 'WARNING') { addChat(null, '⚠️ ' + msg[1]); return; }
  if (cmd === 'ERROR') { addChat(null, '❌ ' + msg[1]); return; }
  if (cmd === 'NICK' || cmd === 'PROTO' || cmd === 'SERVER_MESSAGE' || cmd === 'NOTICE') return;
  console.log('Unhandled:', msg);
}

// ── Rooms ──
function parseRooms(data) {
  // Proto 48+: 9 fields per room: flags, name, playerCount, teamCount, owner, map, script, scheme, weapons
  rooms = [];
  for (var i = 0; i + 8 < data.length; i += 9) {
    rooms.push({
      flags: data[i],
      name: data[i+1],
      players: parseInt(data[i+2]) || 0,
      teams: parseInt(data[i+3]) || 0,
      owner: data[i+4],
      map: data[i+5],
      script: data[i+6],
      scheme: data[i+7],
      weapons: data[i+8]
    });
  }
  renderRooms();
}

function renderRooms() {
  var el = document.getElementById('rooms-list');
  if (rooms.length === 0) {
    el.innerHTML = '<div style="padding:16px;text-align:center;color:#8892b0;font-size:13px">No rooms. Create one!</div>';
    return;
  }
  el.innerHTML = rooms.map(function(r) {
    return '<div class="room-item" onclick="joinRoom(\'' + esc(r.name) + '\')">' +
      '<div class="room-name">' + esc(r.name) + '</div>' +
      '<div class="room-info">' + r.players + ' players · ' + esc(r.owner) + ' · ' + esc(r.map) + '</div>' +
      '</div>';
  }).join('');
}

// ── Room actions ──
function createRoom() {
  var name = prompt('Room name:');
  if (!name) return;
  send(['CREATE_ROOM', name]);
  enterRoom(name);
}

function joinRoom(name) {
  send(['JOIN_ROOM', name]);
  enterRoom(name);
}

function enterRoom(name) {
  inRoom = true;
  players = [{nick:myNick, ready:false, inGame:false}];
  teams = [];
  roomCfg = {};
  document.getElementById('lobby-view').style.display = 'none';
  document.getElementById('room-view').style.display = 'flex';
  document.getElementById('room-name-display').textContent = name;
  renderPlayers(); renderTeams(); updateRoomUI();
}

function leaveRoom() {
  send(['PART']);
  inRoom = false; isChief = false; players = []; teams = []; roomCfg = {};
  document.getElementById('lobby-view').style.display = 'flex';
  document.getElementById('room-view').style.display = 'none';
  send(['LIST']);
}

function toggleReady() {
  send(['TOGGLE_READY']);
}

function startGame() {
  send(['START_GAME']);
}

function addTeam() {
  var name = 'Team ' + myNick;
  var color = String(Math.floor(Math.random() * 9));
  var grave = 'Statue'; var fort = 'Plane'; var voice = 'Default'; var flag = 'hedgewars'; var diff = '0';
  var args = ['ADD_TEAM', name, color, grave, fort, voice, flag, diff];
  for (var i = 1; i <= 8; i++) { args.push('Hog ' + i); args.push('NoHat'); }
  send(args);
}

function updateRoomUI() {
  document.getElementById('btn-start').style.display = isChief ? '' : 'none';
  // Disable config controls for non-chief
  ['cfg-mapgen','cfg-theme','cfg-template','cfg-turntime','cfg-sd','cfg-health'].forEach(function(id) {
    document.getElementById(id).disabled = !isChief;
  });
  // Chief sends initial config
  if (isChief && !roomCfg.SEED) {
    var seed = String(Math.random()).slice(2);
    send(['CFG', 'SEED', seed]);
    send(['CFG', 'MAPGEN', document.getElementById('cfg-mapgen').value]);
    send(['CFG', 'THEME', document.getElementById('cfg-theme').value]);
    send(['CFG', 'TEMPLATE', document.getElementById('cfg-template').value]);
    send(['CFG', 'FEATURE_SIZE', '12']);
    send(['CFG', 'AMMO', 'Default', defaultAmmo()]);
    send(['CFG', 'SCHEME', 'Default', buildSchemeString()]);
    roomCfg.SEED = [seed];
  }
}

function defaultAmmo() {
  // Standard ammo: 56 weapons, all probabilities/delays/reinforcements
  var n = 56;
  var init  = '9'.repeat(n); // all weapons available
  var prob  = '0'.repeat(n); // no crate probability
  var delay = '0'.repeat(n); // no delay
  var reinf = '0'.repeat(n); // no reinforcement
  return init + prob + delay + reinf;
}

function renderPlayers() {
  var el = document.getElementById('players-list');
  el.innerHTML = players.map(function(p) {
    var cls = p.ready ? ' ready' : '';
    return '<div class="player-item'+cls+'"><span class="ready-dot"></span>' + esc(p.nick) + (p.ready ? ' ✓' : '') + '</div>';
  }).join('');
}

// ── Chat ──
function addChat(nick, text) {
  var el = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'chat-msg' + (nick ? '' : ' sys');
  div.innerHTML = nick ? '<span class="nick">' + esc(nick) + ':</span> ' + esc(text) : esc(text);
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function sendChat() {
  var input = document.getElementById('chat-text');
  var text = input.value.trim();
  if (!text) return;
  send(['CHAT', text]);
  input.value = '';
}

function sendCfg() {
  if (!isChief) return;
  send(['CFG', 'MAPGEN', document.getElementById('cfg-mapgen').value]);
  send(['CFG', 'THEME', document.getElementById('cfg-theme').value]);
  send(['CFG', 'TEMPLATE', document.getElementById('cfg-template').value]);
  send(['CFG', 'SCHEME', 'Default', buildSchemeString()]);
  send(['CFG', 'FEATURE_SIZE', document.getElementById('cfg-health').value || '12']);
}

function buildSchemeString() {
  // Minimal scheme: gameflags booleans (27) + params (17) + scriptparam
  // For simplicity, use defaults matching "Default" scheme
  var tt = document.getElementById('cfg-turntime').value;
  var sd = document.getElementById('cfg-sd').value;
  var hp = document.getElementById('cfg-health').value || '100';
  // 27 boolean flags (all false = default), then params
  var flags = 'false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,false,false,false,false,false,true,false,false,false,false,false,false';
  var params = [
    '100',   // damagepct
    tt,      // turntime (ms)
    '100',   // (unused)
    sd,      // sd_turns
    '5',     // casefreq
    '3',     // minestime
    '4',     // minesnum
    '0',     // minedudpct
    '2',     // explosives
    '0',     // airmines
    '35',    // healthprob
    '25',    // hcaseamount
    '47',    // waterrise
    '5',     // healthdec
    '100',   // ropepct
    '100',   // getawaytime
    '0'      // worldedge
  ];
  return flags + ',' + params.join(',') + ',';
}

function applyCfgToUI(param, vals) {
  if (isChief) return; // chief already has correct UI
  if (param === 'MAPGEN') document.getElementById('cfg-mapgen').value = vals[0];
  if (param === 'THEME') document.getElementById('cfg-theme').value = vals[0];
  if (param === 'TEMPLATE') document.getElementById('cfg-template').value = vals[0];
}

function renderTeams() {
  var el = document.getElementById('teams-list');
  if (!el) return;
  var colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff','#ff8000','#8000ff','#80ff00'];
  el.innerHTML = teams.map(function(t) {
    var c = colors[parseInt(t.color)] || '#fff';
    var mine = t.owner === myNick;
    return '<div class="player-item" style="border-left:3px solid '+c+';padding-left:8px">' +
      '<span style="color:'+c+'">' + esc(t.name) + '</span>' +
      '<span style="color:#8892b0;font-size:11px;margin-left:8px">' + t.hhnum + ' hogs · ' + esc(t.owner) + '</span>' +
      (mine ? ' <button class="btn btn-sm btn-danger" onclick="removeTeam(\''+esc(t.name)+'\')">✕</button>' : '') +
      '</div>';
  }).join('');
}

function removeTeam(name) { send(['REMOVE_TEAM', name]); }

function handleEngineMsg(b64) {
  // Relay EM from server directly into engine's message queue (same page!)
  if (window.Module && window.Module.HWEngine && window.Module.HWEngine.mpConfig) {
    var raw = atob(b64);
    for (var i = 0; i < raw.length; i++) window.Module.HWEngine.messageQueue.push(raw.charCodeAt(i));
  }
}

function launchEngine() {
  var seed = (roomCfg.SEED && roomCfg.SEED[0]) || String(Date.now());
  var mapgen = (roomCfg.MAPGEN && roomCfg.MAPGEN[0]) || '0';
  var theme = (roomCfg.THEME && roomCfg.THEME[0]) || 'Nature';
  var template = (roomCfg.TEMPLATE && roomCfg.TEMPLATE[0]) || '0';
  var featureSize = (roomCfg.FEATURE_SIZE && roomCfg.FEATURE_SIZE[0]) || '12';
  var script = (roomCfg.SCRIPT && roomCfg.SCRIPT[0]) || '';
  var schemeData = (roomCfg.SCHEME && roomCfg.SCHEME.length > 1) ? roomCfg.SCHEME[1] : '';
  var schemeParts = schemeData ? schemeData.split(',') : [];
  var ammoData = (roomCfg.AMMO && roomCfg.AMMO.length > 1) ? roomCfg.AMMO[1] : '';

  var gameConfig = {
    mode: 'TN', seed: seed, mapgen: mapgen, theme: theme, template: template,
    featureSize: featureSize, script: script, scheme: schemeParts, ammo: ammoData,
    teams: teams, myNick: myNick
  };

  startEngine(gameConfig);
}

function startEngine(mpConfig) {
  // Show game overlay
  var overlay = document.getElementById('game-overlay');
  overlay.style.display = 'block';
  var canvas = document.getElementById('game-canvas');
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  canvas.focus();

  // Create WebGL2 context with optimal attributes
  var gl = canvas.getContext('webgl2', {
    alpha:false, antialias:false, depth:false, desynchronized:false,
    failIfMajorPerformanceCaveat:false, powerPreference:'high-performance',
    premultipliedAlpha:true, preserveDrawingBuffer:false, stencil:false
  });
  if (!gl) { alert('WebGL2 not available'); return; }

  document.getElementById('game-status').textContent = 'Downloading engine...';

  // Set up Module for Emscripten — pre.js will find this
  window.Module = {
    canvas: canvas,
    preinitializedWebGLContext: gl,
    noInitialRun: false,
    arguments: ['--prefix', '/Data', '--user-prefix', '/Data', 'test.hwd'],
    print: function(t) { if(t) console.log('[Engine]', t); },
    printErr: function(t) {
      if (!t) return;
      if (t.indexOf('dependency: fp') !== -1) return;
      console.error('[Engine Error]', t);
    },
    setStatus: function(text) {
      var el = document.getElementById('game-status');
      if (!text) { el.textContent = 'Running'; return; }
      var m = text.match(/\((\d+)\/(\d+)\)/);
      if (m) el.textContent = 'Downloading... ' + (parseInt(m[1])/1048576|0) + ' / ' + (parseInt(m[2])/1048576|0) + ' MB';
      else el.textContent = text;
    },
    locateFile: function(path) { return path; },
    totalDependencies: 0,
    monitorRunDependencies: function(left) {
      this.totalDependencies = Math.max(this.totalDependencies, left);
      this.setStatus(left ? 'Loading... ('+(this.totalDependencies-left)+'/'+this.totalDependencies+')' : 'Ready');
    }
  };

  // If multiplayer, set mpConfig so pre.js uses startMultiplayerGame instead of startHotseatGame
  if (mpConfig) {
    // pre.js checks HWEngine.mpConfig — we set it after script loads since pre.js creates HWEngine
    window._webwars_mpConfig = mpConfig;
  }

  // Hook: intercept engine EM output to relay to server (override writeIPC after pre.js loads)
  window._webwars_emRelay = function(b64) {
    send(['EM', b64]);
  };
  window._webwars_roundFinished = function() {
    send(['ROUNDFINISHED', '1']);
    exitGame();
  };

  // Dynamically load hwengine.js (which includes pre.js baked in)
  var script = document.createElement('script');
  script.src = 'hwengine.js';
  script.onload = function() {
    // pre.js has now run and created Module.HWEngine
    // Inject mpConfig if multiplayer
    if (window._webwars_mpConfig && window.Module.HWEngine) {
      window.Module.HWEngine.mpConfig = window._webwars_mpConfig;
      console.log('[Lobby] MP config injected into engine');
    }
  };
  document.body.appendChild(script);
}

function exitGame() {
  // Can't cleanly unload Emscripten — reload page to reset
  // WS will reconnect automatically after reload
  location.reload();
}

// Resize game canvas on window resize
window.addEventListener('resize', function() {
  var c = document.getElementById('game-canvas');
  if (c && document.getElementById('game-overlay').style.display === 'block') {
    c.style.width = window.innerWidth + 'px';
    c.style.height = window.innerHeight + 'px';
  }
});

// ── Quick Play (local hotseat) ──
function playLocal() {
  startEngine(null); // null = hotseat mode, pre.js uses startHotseatGame
}

// ── Util ──
function esc(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
