<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>WebWars ‚Äî Lobby</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
a{color:#4fc3f7;text-decoration:none}
button{cursor:pointer;font-family:inherit}

/* Header */
header{background:linear-gradient(180deg,#161b2e,#0d1120);padding:12px 24px;border-bottom:1px solid #1e2744;display:flex;align-items:center;gap:16px}
.logo{font-weight:900;font-size:20px;letter-spacing:2px;background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff,#9b59b6);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 3s linear infinite}
@keyframes shine{to{background-position:200% center}}
#conn-status{font-size:12px;padding:3px 10px;border-radius:10px;background:#1a2040;color:#8892b0}
#conn-status.ok{background:#1b3a1b;color:#66bb6a}
#conn-status.err{background:#3a1b1b;color:#ef5350}
.spacer{flex:1}
#nick-display{font-size:13px;color:#8892b0}

/* Main layout */
main{flex:1;display:flex;overflow:hidden}

/* Panels */
.panel{display:flex;flex-direction:column;border-right:1px solid #1e2744}
.panel-header{padding:10px 16px;background:#111628;border-bottom:1px solid #1e2744;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px}
.panel-body{flex:1;overflow-y:auto;padding:8px}

/* Rooms panel */
#rooms-panel{width:320px}
.room-item{padding:10px 12px;border-radius:6px;margin-bottom:4px;cursor:pointer;font-size:13px;transition:background .1s}
.room-item:hover{background:#1a2040}
.room-item .room-name{font-weight:600;margin-bottom:2px}
.room-item .room-info{font-size:11px;color:#8892b0}

/* Center area */
#center{flex:1;display:flex;flex-direction:column}

/* Room config / game area */
#room-view{flex:1;display:flex;flex-direction:column;display:none}
#room-header{padding:12px 16px;background:#111628;border-bottom:1px solid #1e2744;display:flex;align-items:center;gap:12px}
#room-header h2{font-size:15px;font-weight:600}
#room-config{flex:1;padding:16px;overflow-y:auto;display:flex;gap:16px;flex-wrap:wrap;align-content:flex-start}
.config-section{background:#111628;border:1px solid #1e2744;border-radius:8px;padding:14px;min-width:280px;flex:1}
.config-section h3{font-size:13px;font-weight:600;margin-bottom:10px;color:#4fc3f7}
.config-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:13px}
.config-row label{color:#8892b0}
.config-row select,.config-row input{background:#0d1120;border:1px solid #2a3352;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:12px}

/* Welcome / lobby view */
#lobby-view{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#lobby-view h1{font-size:28px;font-weight:800;background:linear-gradient(135deg,#4fc3f7,#66bb6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#lobby-view p{color:#8892b0;font-size:14px;max-width:400px;text-align:center}

/* Chat */
#chat-panel{width:280px;display:flex;flex-direction:column;border-left:1px solid #1e2744}
#chat-messages{flex:1;overflow-y:auto;padding:8px;font-size:12px}
.chat-msg{margin-bottom:4px;word-wrap:break-word}
.chat-msg .nick{font-weight:600;color:#4fc3f7}
.chat-msg.sys{color:#8892b0;font-style:italic}
#chat-input{display:flex;border-top:1px solid #1e2744}
#chat-input input{flex:1;background:#0d1120;border:none;color:#e0e0e0;padding:10px 12px;font-size:12px;outline:none}
#chat-input button{background:#1a2040;border:none;color:#4fc3f7;padding:10px 14px;font-size:12px}

/* Buttons */
.btn{padding:8px 16px;border-radius:6px;border:1px solid #2a3352;background:#1a2040;color:#e0e0e0;font-size:13px;transition:all .15s}
.btn:hover{border-color:#4fc3f7;color:#4fc3f7}
.btn-primary{background:linear-gradient(135deg,#1565c0,#0d47a1);border-color:#1976d2;color:#fff}
.btn-primary:hover{background:linear-gradient(135deg,#1976d2,#1565c0)}
.btn-success{background:linear-gradient(135deg,#2e7d32,#1b5e20);border-color:#388e3c;color:#fff}
.btn-success:hover{background:linear-gradient(135deg,#388e3c,#2e7d32)}
.btn-danger{background:#3a1b1b;border-color:#c62828;color:#ef5350}
.btn-sm{padding:5px 10px;font-size:11px}

/* Players list in room */
.player-item{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:13px;border-radius:4px}
.player-item.ready{color:#66bb6a}
.player-item .ready-dot{width:8px;height:8px;border-radius:50%;background:#2a3352}
.player-item.ready .ready-dot{background:#66bb6a}

/* Login overlay */
#login-overlay{position:fixed;inset:0;background:rgba(6,8,18,0.9);display:flex;align-items:center;justify-content:center;z-index:100}

/* Game overlay ‚Äî fullscreen canvas over lobby */
#game-overlay{display:none;position:fixed;inset:0;z-index:150;background:#000}
#game-overlay canvas{width:100vw;height:100vh;display:block}
#game-overlay .game-topbar{position:absolute;top:0;left:0;right:0;height:32px;background:rgba(13,17,32,0.8);display:flex;align-items:center;padding:0 12px;z-index:160;font-size:12px}
#game-overlay .game-topbar span{color:#8892b0;margin-right:16px}
#game-overlay .game-topbar button{background:none;border:1px solid #2a3352;color:#8892b0;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:11px;margin-left:auto}
#login-box{background:#111628;border:1px solid #1e2744;border-radius:12px;padding:32px;text-align:center;min-width:320px}
#login-box h2{margin-bottom:16px;font-size:20px}
#login-box input{width:100%;padding:10px 14px;background:#0d1120;border:1px solid #2a3352;border-radius:6px;color:#e0e0e0;font-size:14px;margin-bottom:12px;outline:none;text-align:center}
#login-box input:focus{border-color:#4fc3f7}
</style>
</head>
<body>

<!-- Login -->
<div id="login-overlay">
  <div id="login-box">
    <h2>‚öîÔ∏è WebWars</h2>
    <p style="color:#8892b0;font-size:13px;margin-bottom:16px">Enter a nickname to join</p>
    <input id="nick-input" type="text" placeholder="Nickname" maxlength="40" autofocus>
    <br>
    <button class="btn btn-primary" onclick="doLogin()" style="width:100%">Join Server</button>
  </div>
</div>

<!-- Game overlay (hidden, shown when engine loads) -->
<div id="game-overlay">
  <div class="game-topbar">
    <span id="game-status">Loading engine...</span>
    <button onclick="exitGame()">‚úï Exit</button>
  </div>
  <canvas id="canvas" class="emscripten" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
</div>

<header>
  <span class="logo">WEBWARS</span>
  <span id="conn-status">Disconnected</span>
  <span class="spacer"></span>
  <span id="nick-display"></span>
  <button class="btn btn-sm" onclick="playLocal()">‚ö° Quick Play</button>
  <a class="btn btn-sm" href="https://github.com/apmlabs/webwars" target="_blank">‚≠ê GitHub</a>
</header>

<main>
  <!-- Rooms list -->
  <div id="rooms-panel" class="panel">
    <div class="panel-header">
      Rooms
      <span class="spacer"></span>
      <button class="btn btn-sm btn-primary" onclick="createRoom()">+ New</button>
    </div>
    <div class="panel-body" id="rooms-list"></div>
  </div>

  <!-- Center -->
  <div id="center">
    <!-- Lobby welcome (shown when not in a room) -->
    <div id="lobby-view">
      <h1>WebWars</h1>
      <p>Hedgewars in your browser. Create or join a room to play multiplayer, or hit Quick Play for a local hotseat game.</p>
      <div style="text-align:left;background:#111628;border:1px solid #1e2744;border-radius:8px;padding:16px 20px;max-width:440px;margin-top:8px;font-size:13px;line-height:1.7">
        <div style="font-weight:600;margin-bottom:6px;color:#4fc3f7">How to Play</div>
        <div style="color:#8892b0">
          <b style="color:#e0e0e0">Multiplayer:</b> Create a room ‚Üí other player joins ‚Üí both add a team ‚Üí chief starts the game<br>
          <b style="color:#e0e0e0">Quick Play:</b> Two teams on one keyboard, taking turns<br>
          <b style="color:#e0e0e0">In-game:</b> Right-click to pick a weapon, Space to fire, Arrow keys to move
        </div>
      </div>
    </div>

    <!-- Room view (shown when in a room) -->
    <div id="room-view">
      <div id="room-header">
        <button class="btn btn-sm btn-danger" onclick="leaveRoom()">‚Üê Leave</button>
        <h2 id="room-name-display"></h2>
        <span class="spacer"></span>
        <button class="btn btn-sm" id="btn-ready" onclick="toggleReady()">Ready</button>
        <button class="btn btn-sm btn-success" id="btn-start" onclick="startGame()" style="display:none">Start Game</button>
      </div>
      <div id="room-config">
        <div class="config-section">
          <h3>Map</h3>
          <div class="config-row"><label>Type</label><select id="cfg-mapgen" onchange="sendCfg()"><option value="0">Random</option><option value="1">Maze</option><option value="2">Drawn</option><option value="3">Perlin</option></select></div>
          <div class="config-row"><label>Theme</label><select id="cfg-theme" onchange="sendCfg()"></select></div>
          <div class="config-row"><label>Template</label><select id="cfg-template" onchange="sendCfg()"><option value="0">Small</option><option value="1">Medium</option><option value="2">Large</option><option value="3">Cavern</option><option value="4">Wacky</option></select></div>
        </div>
        <div class="config-section">
          <h3>Game Settings</h3>
          <div class="config-row"><label>Scheme</label><select id="cfg-scheme" onchange="onSchemeChange()"></select></div>
          <div class="config-row"><label>Weapons</label><select id="cfg-weapons" onchange="onWeaponsChange()"></select></div>
          <div class="config-row"><label>Style</label><select id="cfg-style" onchange="onStyleChange()"></select></div>
        </div>
        <div class="config-section">
          <h3>Players</h3>
          <div id="players-list"></div>
          <h3 style="margin-top:12px">Teams</h3>
          <div id="teams-list"></div>
          <button class="btn btn-sm" onclick="addTeam()" style="margin-top:8px">+ Add Team</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat-panel" class="panel">
    <div class="panel-header">Chat</div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input id="chat-text" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">Send</button>
    </div>
  </div>
</main>

<script src="gameconfig.js"></script>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
var ws = null;
var myNick = '';
var inRoom = false;
var isChief = false;
var rooms = [];
var players = [];
var teams = [];
var roomCfg = {};
var curScheme = GameConfig.SCHEMES[0];
var curWeapon = GameConfig.WEAPONS[0];
var curStyle = 'Normal';
var roomPoll = null;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(function() {
  var sel;
  // Themes ‚Äî use the allThemes list from pre.js (via HWEngine) or hardcode the 29
  var allThemes = ['Art','Bamboo','Bath','Beach','Brick','Cake','Castle','Cave','Cheese',
    'Christmas','City','Compost','Desert','Digital','EarthRise','Freeway',
    'Fruit','Golf','Halloween','Hell','Hoggywood','Island','Jungle','Nature',
    'Olympics','Sheep','Snow','Stage','Underwater'];
  sel = document.getElementById('cfg-theme');
  allThemes.forEach(function(t) {
    var o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o);
  });
  // Schemes
  sel = document.getElementById('cfg-scheme');
  GameConfig.SCHEMES.forEach(function(s) {
    var o = document.createElement('option'); o.value = s.name; o.textContent = s.name; sel.appendChild(o);
  });
  // Weapons
  sel = document.getElementById('cfg-weapons');
  GameConfig.WEAPONS.forEach(function(w) {
    var o = document.createElement('option'); o.value = w.name; o.textContent = w.name; sel.appendChild(o);
  });
  // Styles
  sel = document.getElementById('cfg-style');
  GameConfig.STYLES.forEach(function(s) {
    var o = document.createElement('option'); o.value = s.name; o.textContent = s.name; sel.appendChild(o);
  });
  document.getElementById('nick-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doLogin();
  });
})();

// ‚îÄ‚îÄ Connection ‚îÄ‚îÄ
function connect() {
  var host = location.hostname || 'localhost';
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsUrl = location.port === '8081' ? 'ws://' + host + ':8080' : proto + '//' + host + '/ws';
  ws = new WebSocket(wsUrl);
  setStatus('Connecting...', '');

  ws.onopen = function() { setStatus('Connected', 'ok'); };
  ws.onclose = function() { setStatus('Disconnected', 'err'); clearInterval(roomPoll); setTimeout(connect, 3000); };
  ws.onerror = function() { setStatus('Error', 'err'); };
  ws.onmessage = function(e) { handleMsg(JSON.parse(e.data)); };
  // Poll room list every 3s when in lobby
  roomPoll = setInterval(function() { if (!inRoom && ws.readyState === 1) send(['LIST']); }, 3000);
}

function send(arr) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(arr));
}

function setStatus(text, cls) {
  var el = document.getElementById('conn-status');
  el.textContent = text;
  el.className = cls || '';
}

// ‚îÄ‚îÄ Login ‚îÄ‚îÄ
function doLogin() {
  myNick = document.getElementById('nick-input').value.trim();
  if (!myNick) return;
  document.getElementById('login-overlay').style.display = 'none';
  document.getElementById('nick-display').textContent = myNick;
  connect();
}

// ‚îÄ‚îÄ Protocol handler ‚îÄ‚îÄ
function handleMsg(msg) {
  var cmd = msg[0];

  if (cmd === 'CONNECTED') { send(['NICK', myNick]); send(['PROTO', '60']); return; }
  if (cmd === 'LOBBY:JOINED') { addChat(null, msg.slice(1).join(', ') + ' joined the lobby'); if (!inRoom) send(['LIST']); return; }
  if (cmd === 'ROOMS') { parseRooms(msg.slice(1)); return; }
  if (cmd === 'ROOM' && (msg[1] === 'ADD' || msg[1] === 'DEL' || msg[1] === 'UPD')) { send(['LIST']); return; }

  if (cmd === 'JOINED') {
    msg.slice(1).forEach(function(n) {
      if (!players.find(function(p){return p.nick===n})) players.push({nick:n, ready:false, inGame:false});
    });
    renderPlayers(); addChat(null, msg.slice(1).join(', ') + ' joined'); return;
  }
  if (cmd === 'LEFT') {
    var who = msg[1];
    players = players.filter(function(p){return p.nick!==who});
    teams = teams.filter(function(t){return t.owner!==who});
    renderPlayers(); renderTeams(); addChat(null, who + ' left'); return;
  }

  if (cmd === 'CLIENT_FLAGS' || cmd === 'CF') {
    var flags = msg[1]; var nicks = msg.slice(2);
    nicks.forEach(function(n) {
      var p = players.find(function(x){return x.nick===n});
      if (!p) return;
      if (flags.indexOf('+h') !== -1) { if (n === myNick) { isChief = true; updateRoomUI(); } }
      if (flags.indexOf('+r') !== -1) p.ready = true;
      if (flags.indexOf('-r') !== -1) p.ready = false;
      if (flags.indexOf('+g') !== -1) p.inGame = true;
      if (flags.indexOf('-g') !== -1) p.inGame = false;
    });
    renderPlayers(); return;
  }

  if (cmd === 'CHAT') { addChat(msg[1], msg[2]); return; }

  // Team management
  if (cmd === 'TEAM_ACCEPTED') {
    // Add our own team to the teams array (server confirmed it)
    var tname = msg[1];
    if (!teams.find(function(t){return t.name===tname}) && window._webwars_pendingTeam && window._webwars_pendingTeam.name === tname) {
      teams.push(window._webwars_pendingTeam);
      window._webwars_pendingTeam = null;
    }
    renderTeams(); addChat(null, 'Team "' + tname + '" added'); return;
  }
  if (cmd === 'ADD_TEAM') {
    // From other player: ADD_TEAM, name, grave, fort, voicepack, flag, owner, diff, hog1name, hog1hat...
    var t = {name:msg[1], grave:msg[2], fort:msg[3], voicepack:msg[4], flag:msg[5], owner:msg[6], diff:msg[7], color:'0', hogs:[], hhnum:4};
    for (var i=8; i+1<msg.length; i+=2) t.hogs.push({name:msg[i], hat:msg[i+1]});
    teams.push(t); renderTeams(); addChat(null, t.owner + ' added team "' + t.name + '"'); return;
  }
  if (cmd === 'REMOVE_TEAM') {
    teams = teams.filter(function(t){return t.name!==msg[1]});
    renderTeams(); addChat(null, 'Team "' + msg[1] + '" removed'); return;
  }
  if (cmd === 'TEAM_COLOR') {
    var tc = teams.find(function(t){return t.name===msg[1]});
    if (tc) tc.color = msg[2];
    renderTeams(); return;
  }
  if (cmd === 'HH_NUM') {
    var th = teams.find(function(t){return t.name===msg[1]});
    if (th) th.hhnum = parseInt(msg[2]);
    renderTeams(); return;
  }

  // Config sync
  if (cmd === 'CFG') {
    if (msg[1] === 'FULLMAPCONFIG') {
      // Server sends map params as ordered values: FEATURE_SIZE, MAP, MAPGEN, MAZE_SIZE, SEED, TEMPLATE
      var v = msg.slice(2);
      roomCfg['FEATURE_SIZE'] = [v[0] || '12'];
      roomCfg['MAP'] = [v[1] || '+rnd+'];
      roomCfg['MAPGEN'] = [v[2] || '0'];
      roomCfg['MAZE_SIZE'] = [v[3] || '0'];
      roomCfg['SEED'] = [v[4] || String(Date.now())];
      roomCfg['TEMPLATE'] = [v[5] || '0'];
      addChat(null, 'Map config received (seed=' + (v[4]||'?') + ')');
    } else {
      roomCfg[msg[1]] = msg.slice(2);
      applyCfgToUI(msg[1], msg.slice(2));
      addChat(null, 'Config: ' + msg[1] + ' = ' + msg.slice(2).join(' '));
    }
    return;
  }

  // Game start
  if (cmd === 'RUN_GAME') { addChat(null, 'Game starting!'); launchEngine(); return; }
  if (cmd === 'ROUND_FINISHED') { addChat(null, 'Round finished'); return; }
  if (cmd === 'EM') { handleEngineMsg(msg[1]); return; }

  if (cmd === 'PING') { send(['PONG']); return; }
  if (cmd === 'BYE') { addChat(null, 'Disconnected: ' + (msg[1]||'')); return; }
  if (cmd === 'WARNING') { addChat(null, '‚ö†Ô∏è ' + msg[1]); return; }
  if (cmd === 'ERROR') { addChat(null, '‚ùå ' + msg[1]); return; }
  if (cmd === 'ASKPASSWORD') { addChat(null, 'üîí This nick is registered. Password auth not supported in web client.'); return; }
  if (cmd === 'KICKED') { addChat(null, 'üö´ You were kicked from the room'); leaveRoom(); return; }
  if (cmd === 'ROOM' && msg[1] === 'DEL' || cmd === 'ROOMABANDONED') {
    if (inRoom) { addChat(null, 'üö™ Room was closed'); leaveRoom(); }
    return;
  }
  if (cmd === 'JOINING') { addChat(null, 'Joining room...'); return; }
  if (cmd === 'TEAMCHAT') { addChat('[team] ' + msg[1], msg[2]); return; }
  if (cmd === 'NICK' || cmd === 'PROTO' || cmd === 'SERVER_MESSAGE' || cmd === 'NOTICE') return;
  console.log('Unhandled:', msg);
}

// ‚îÄ‚îÄ Rooms ‚îÄ‚îÄ
function parseRooms(data) {
  // Proto 48+: 9 fields per room: flags, name, playerCount, teamCount, owner, map, script, scheme, weapons
  rooms = [];
  for (var i = 0; i + 8 < data.length; i += 9) {
    rooms.push({
      flags: data[i],
      name: data[i+1],
      players: parseInt(data[i+2]) || 0,
      teams: parseInt(data[i+3]) || 0,
      owner: data[i+4],
      map: data[i+5],
      script: data[i+6],
      scheme: data[i+7],
      weapons: data[i+8]
    });
  }
  renderRooms();
}

function renderRooms() {
  var el = document.getElementById('rooms-list');
  if (rooms.length === 0) {
    el.innerHTML = '<div style="padding:16px;text-align:center;color:#8892b0;font-size:13px">No rooms. Create one!</div>';
    return;
  }
  el.innerHTML = rooms.map(function(r) {
    return '<div class="room-item" onclick="joinRoom(\'' + esc(r.name) + '\')">' +
      '<div class="room-name">' + esc(r.name) + '</div>' +
      '<div class="room-info">' + r.players + ' players ¬∑ ' + esc(r.owner) + ' ¬∑ ' + esc(r.map) + '</div>' +
      '</div>';
  }).join('');
}

// ‚îÄ‚îÄ Room actions ‚îÄ‚îÄ
function createRoom() {
  var name = prompt('Room name:');
  if (!name) return;
  send(['CREATE_ROOM', name]);
  enterRoom(name);
}

function joinRoom(name) {
  if (inRoom) return;
  send(['JOIN_ROOM', name]);
  enterRoom(name);
}

function enterRoom(name) {
  inRoom = true;
  players = [{nick:myNick, ready:false, inGame:false}];
  teams = [];
  roomCfg = {};
  document.getElementById('lobby-view').style.display = 'none';
  document.getElementById('room-view').style.display = 'flex';
  document.getElementById('room-name-display').textContent = name;
  renderPlayers(); renderTeams(); updateRoomUI();
  // Auto-add team after short delay (wait for server to process join)
  setTimeout(function() { addTeam(); }, 500);
}

function leaveRoom() {
  send(['PART']);
  inRoom = false; isChief = false; players = []; teams = []; roomCfg = {};
  document.getElementById('lobby-view').style.display = 'flex';
  document.getElementById('room-view').style.display = 'none';
  send(['LIST']);
}

function toggleReady() {
  send(['TOGGLE_READY']);
}

function startGame() {
  send(['START_GAME']);
}

function addTeam() {
  var name = 'Team ' + myNick;
  if (teams.find(function(t){return t.name===name})) return;
  var color = String(Math.floor(Math.random() * 9));
  var grave = 'Statue'; var fort = 'Plane'; var voice = 'Default'; var flag = 'hedgewars'; var diff = '0';
  var hogs = [];
  var args = ['ADD_TEAM', name, color, grave, fort, voice, flag, diff];
  for (var i = 1; i <= 8; i++) { args.push('Hog ' + i); args.push('NoHat'); hogs.push({name:'Hog '+i, hat:'NoHat'}); }
  // Save pending team so TEAM_ACCEPTED can add it to teams[]
  window._webwars_pendingTeam = {name:name, grave:grave, fort:fort, voicepack:voice, flag:flag, owner:myNick, diff:diff, color:color, hogs:hogs, hhnum:4};
  send(args);
}

function updateRoomUI() {
  document.getElementById('btn-start').style.display = isChief ? '' : 'none';
  ['cfg-mapgen','cfg-theme','cfg-template','cfg-scheme','cfg-weapons','cfg-style'].forEach(function(id) {
    document.getElementById(id).disabled = !isChief;
  });
  if (isChief && !roomCfg.SEED) {
    var seed = String(Math.random()).slice(2);
    send(['CFG', 'SEED', seed]);
    send(['CFG', 'MAPGEN', document.getElementById('cfg-mapgen').value]);
    send(['CFG', 'THEME', document.getElementById('cfg-theme').value]);
    send(['CFG', 'TEMPLATE', document.getElementById('cfg-template').value]);
    send(['CFG', 'FEATURE_SIZE', '12']);
    send(['CFG', 'AMMO', curWeapon.name, curWeapon.ammo]);
    send(['CFG', 'SCHEME'].concat([curScheme.name]).concat(GameConfig.buildSchemeArray(curScheme)));
    if (curStyle !== 'Normal') send(['CFG', 'SCRIPT', curStyle]);
    roomCfg.SEED = [seed];
  }
}

function onSchemeChange() {
  if (!isChief) return;
  curScheme = GameConfig.findScheme(document.getElementById('cfg-scheme').value);
  send(['CFG', 'SCHEME'].concat([curScheme.name]).concat(GameConfig.buildSchemeArray(curScheme)));
}

function onWeaponsChange() {
  if (!isChief) return;
  curWeapon = GameConfig.findWeapon(document.getElementById('cfg-weapons').value);
  send(['CFG', 'AMMO', curWeapon.name, curWeapon.ammo]);
}

function onStyleChange() {
  if (!isChief) return;
  curStyle = document.getElementById('cfg-style').value;
  if (curStyle !== 'Normal') send(['CFG', 'SCRIPT', curStyle]);
}

function renderPlayers() {
  var el = document.getElementById('players-list');
  el.innerHTML = players.map(function(p) {
    var cls = p.ready ? ' ready' : '';
    return '<div class="player-item'+cls+'"><span class="ready-dot"></span>' + esc(p.nick) + (p.ready ? ' ‚úì' : '') + '</div>';
  }).join('');
}

// ‚îÄ‚îÄ Chat ‚îÄ‚îÄ
function addChat(nick, text) {
  var el = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'chat-msg' + (nick ? '' : ' sys');
  div.innerHTML = nick ? '<span class="nick">' + esc(nick) + ':</span> ' + esc(text) : esc(text);
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function sendChat() {
  var input = document.getElementById('chat-text');
  var text = input.value.trim();
  if (!text) return;
  send(['CHAT', text]);
  input.value = '';
}

function sendCfg() {
  if (!isChief) return;
  send(['CFG', 'MAPGEN', document.getElementById('cfg-mapgen').value]);
  send(['CFG', 'THEME', document.getElementById('cfg-theme').value]);
  send(['CFG', 'TEMPLATE', document.getElementById('cfg-template').value]);
}

function applyCfgToUI(param, vals) {
  if (isChief) return;
  if (param === 'MAPGEN') document.getElementById('cfg-mapgen').value = vals[0];
  if (param === 'THEME') document.getElementById('cfg-theme').value = vals[0];
  if (param === 'TEMPLATE') document.getElementById('cfg-template').value = vals[0];
  if (param === 'SCHEME' && vals[0]) {
    var s = GameConfig.findScheme(vals[0]);
    if (s) { curScheme = s; document.getElementById('cfg-scheme').value = s.name; }
    else if (vals.length > 2) { curScheme = GameConfig.parseSchemeArray(vals.slice(1)); }
  }
  if (param === 'AMMO' && vals[0]) {
    var w = GameConfig.findWeapon(vals[0]);
    if (w) { curWeapon = w; document.getElementById('cfg-weapons').value = w.name; }
    else if (vals[1]) { curWeapon = {name:vals[0], ammo:vals[1]}; }
  }
  if (param === 'SCRIPT') { curStyle = vals[0] || 'Normal'; document.getElementById('cfg-style').value = curStyle; }
}

function renderTeams() {
  var el = document.getElementById('teams-list');
  if (!el) return;
  var colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff','#ff8000','#8000ff','#80ff00'];
  el.innerHTML = teams.map(function(t) {
    var c = colors[parseInt(t.color)] || '#fff';
    var mine = t.owner === myNick;
    return '<div class="player-item" style="border-left:3px solid '+c+';padding-left:8px">' +
      '<span style="color:'+c+'">' + esc(t.name) + '</span>' +
      '<span style="color:#8892b0;font-size:11px;margin-left:8px">' + t.hhnum + ' hogs ¬∑ ' + esc(t.owner) + '</span>' +
      (mine ? ' <button class="btn btn-sm btn-danger" onclick="removeTeam(\''+esc(t.name)+'\')">‚úï</button>' : '') +
      '</div>';
  }).join('');
}

function removeTeam(name) { send(['REMOVE_TEAM', name]); }

var _emStats = {sent:0, recv:0, lastLog:0};
function handleEngineMsg(b64) {
  // Relay EM from server directly into engine's message queue (same page!)
  if (window.Module && window.Module.HWEngine && window.Module.HWEngine.mpConfig) {
    var raw = atob(b64);
    for (var i = 0; i < raw.length; i++) window.Module.HWEngine.messageQueue.push(raw.charCodeAt(i));
    _emStats.recv++;
    var now = Date.now();
    if (now - _emStats.lastLog > 3000) {
      console.log('[EM] sent=' + _emStats.sent + ' recv=' + _emStats.recv + ' qLen=' + window.Module.HWEngine.messageQueue.length);
      _emStats.lastLog = now;
    }
  } else {
    // Engine not ready yet ‚Äî queue for later injection
    if (!window._webwars_emQueue) window._webwars_emQueue = [];
    window._webwars_emQueue.push(b64);
  }
}

function launchEngine() {
  var seed = (roomCfg.SEED && roomCfg.SEED[0]) || String(Date.now());
  var mapgen = (roomCfg.MAPGEN && roomCfg.MAPGEN[0]) || '0';
  var theme = (roomCfg.THEME && roomCfg.THEME[0]) || 'Nature';
  var template = (roomCfg.TEMPLATE && roomCfg.TEMPLATE[0]) || '0';
  var featureSize = (roomCfg.FEATURE_SIZE && roomCfg.FEATURE_SIZE[0]) || '12';
  var script = curStyle !== 'Normal' ? curStyle : '';

  var gameConfig = {
    mode: 'TN', seed: seed, mapgen: mapgen, theme: theme, template: template,
    featureSize: featureSize, script: script,
    scheme: curScheme, ammo: curWeapon.ammo,
    teams: teams, myNick: myNick
  };
  console.log('[Lobby] launchEngine config:', JSON.stringify({seed:seed, theme:theme, scheme:curScheme.name, weapons:curWeapon.name, style:curStyle, teamCount:teams.length}));
  startEngine(gameConfig);
}

function startEngine(mpConfig) {
  // Show game overlay
  var overlay = document.getElementById('game-overlay');
  overlay.style.display = 'block';
  var canvas = document.getElementById('canvas');
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  canvas.focus();

  // Create WebGL2 context with optimal attributes
  var gl = canvas.getContext('webgl2', {
    alpha:false, antialias:false, depth:false, desynchronized:false,
    failIfMajorPerformanceCaveat:false, powerPreference:'high-performance',
    premultipliedAlpha:true, preserveDrawingBuffer:false, stencil:false
  });
  if (!gl) { alert('WebGL2 not available'); return; }

  document.getElementById('game-status').textContent = 'Downloading engine...';

  // Set up Module for Emscripten ‚Äî pre.js will find this
  window.Module = {
    canvas: canvas,
    preinitializedWebGLContext: gl,
    noInitialRun: false,
    arguments: ['--prefix', '/Data', '--user-prefix', '/Data', 'test.hwd'],
    print: function(t) { if(t) console.log('[Engine]', t); },
    printErr: function(t) {
      if (!t) return;
      if (t.indexOf('dependency: fp') !== -1) return;
      console.error('[Engine Error]', t);
    },
    setStatus: function(text) {
      var el = document.getElementById('game-status');
      if (!text) { el.textContent = 'Running'; return; }
      var m = text.match(/\((\d+)\/(\d+)\)/);
      if (m) el.textContent = 'Downloading... ' + (parseInt(m[1])/1048576|0) + ' / ' + (parseInt(m[2])/1048576|0) + ' MB';
      else el.textContent = text;
    },
    locateFile: function(path) { return path; },
    onAbort: function(what) { console.error('[Engine] ABORT:', what); document.getElementById('game-status').textContent = 'Engine crashed: ' + what; },
    totalDependencies: 0,
    monitorRunDependencies: function(left) {
      this.totalDependencies = Math.max(this.totalDependencies, left);
      this.setStatus(left ? 'Loading... ('+(this.totalDependencies-left)+'/'+this.totalDependencies+')' : 'Ready');
    }
  };

  // If multiplayer, set mpConfig so pre.js uses startMultiplayerGame instead of startHotseatGame
  if (mpConfig) {
    // pre.js checks HWEngine.mpConfig ‚Äî we set it after script loads since pre.js creates HWEngine
    window._webwars_mpConfig = mpConfig;
  }

  // Hook: intercept engine EM output to relay to server (override writeIPC after pre.js loads)
  window._webwars_emRelay = function(b64) {
    send(['EM', b64]);
    if (window._emStats) window._emStats.sent++;
  };
  window._webwars_roundFinished = function() {
    send(['ROUNDFINISHED', '1']);
    exitGame();
  };

  // Dynamically load hwengine.js (which includes pre.js baked in)
  var script = document.createElement('script');
  script.src = 'hwengine.js';
  script.onerror = function(e) { console.error('[Lobby] FAILED to load hwengine.js', e); };
  script.onload = function() {
    console.log('[Lobby] hwengine.js loaded, HWEngine exists:', !!window.Module.HWEngine);
    // pre.js has now run and created Module.HWEngine
    // Inject mpConfig if multiplayer
    if (window._webwars_mpConfig && window.Module.HWEngine) {
      window.Module.HWEngine.mpConfig = window._webwars_mpConfig;
      console.log('[Lobby] MP config injected:', JSON.stringify({
        seed: window._webwars_mpConfig.seed,
        theme: window._webwars_mpConfig.theme,
        teamCount: (window._webwars_mpConfig.teams||[]).length,
        teamNames: (window._webwars_mpConfig.teams||[]).map(function(t){return t.name})
      }));
      // Flush any EM messages that arrived before engine was ready
      if (window._webwars_emQueue) {
        console.log('[Lobby] Flushing', window._webwars_emQueue.length, 'queued EM messages');
        window._webwars_emQueue.forEach(function(b64) { handleEngineMsg(b64); });
        window._webwars_emQueue = null;
      }
    }
  };
  document.body.appendChild(script);
}

function exitGame() {
  // Can't cleanly unload Emscripten ‚Äî reload page to reset
  // WS will reconnect automatically after reload
  location.reload();
}

// Resize game canvas on window resize
window.addEventListener('resize', function() {
  var c = document.getElementById('canvas');
  if (c && document.getElementById('game-overlay').style.display === 'block') {
    c.style.width = window.innerWidth + 'px';
    c.style.height = window.innerHeight + 'px';
  }
});

// ‚îÄ‚îÄ Quick Play (local hotseat) ‚îÄ‚îÄ
function playLocal() {
  startEngine(null); // null = hotseat mode, pre.js uses startHotseatGame
}

// ‚îÄ‚îÄ Util ‚îÄ‚îÄ
function esc(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
